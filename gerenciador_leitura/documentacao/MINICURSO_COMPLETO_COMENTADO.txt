================================================================================
           COMPLEMENTO DO MINICURSO - EXPLICA√á√ïES DAS VIEWS DO PROJETO
================================================================================

Este arquivo complementa o MINICURSO_DJANGO_BOOTSTRAP.txt com explica√ß√µes
detalhadas de cada view do projeto "Leia Bem", mostrando o que cada fun√ß√£o
faz passo a passo.

================================================================================
VIEWS P√öBLICAS (Qualquer pessoa pode acessar)
================================================================================

1) index() - P√°gina Inicial
----------------------------
```python
def index(request):
    """P√°gina inicial"""
    livros_destaque = Livro.objects.order_by('-nota_media')[:6]
```
O QUE FAZ:
1. Busca livros no banco
2. Ordena por nota_media DECRESCENTE (melhores primeiro)
3. [:6] pega apenas os 6 primeiros (LIMIT 6 no SQL)
4. Resultado: 6 livros mais bem avaliados

```python
    livros_na_biblioteca = []
    if request.user.is_authenticated:
        livros_na_biblioteca = ProgressoLeitura.objects.filter(
            usuario=request.user
        ).values_list('livro_id', flat=True)
```
O QUE FAZ:
1. Verifica se usu√°rio est√° logado
2. Se SIM: busca IDs dos livros que o usu√°rio j√° adicionou
3. values_list('livro_id', flat=True) retorna lista simples: [1, 5, 8, 12]
4. Usado no template para mostrar "J√° na biblioteca" nos livros

```python
    return render(request, 'leia_bem/index.html', context)
```
O QUE FAZ:
1. Renderiza template index.html
2. Passa vari√°veis: livros_destaque e livros_na_biblioteca
3. Retorna HTML pronto para o navegador


2) lista_livros() - Lista de Todos os Livros
---------------------------------------------
```python
def lista_livros(request):
    livros = Livro.objects.all()
    
    query = request.GET.get('q')
    if query:
        livros = livros.filter(
            Q(titulo__icontains=query) |
            Q(escritor__nome__icontains=query) |
            Q(editora__nome__icontains=query)
        )
```
O QUE FAZ:
1. Pega TODOS os livros
2. Verifica se tem ?q=termo na URL
3. Se tiver, filtra livros que tenham o termo:
   - NO t√≠tulo OU
   - NO nome do escritor OU
   - NO nome da editora
4. Exemplo: /livros/?q=python ‚Üí encontra livros com "python" em qualquer lugar

```python
    ordem = request.GET.get('ordem', '-nota_media')
    livros = livros.order_by(ordem)
```
O QUE FAZ:
1. Pega par√¢metro ?ordem= da URL
2. Se n√£o tiver, usa '-nota_media' (melhor avaliado primeiro)
3. Ordena livros conforme escolha do usu√°rio
4. Exemplos:
   - ?ordem=titulo ‚Üí ordem alfab√©tica
   - ?ordem=-ano_publicacao ‚Üí mais recentes primeiro


3) detalhe_livro() - Detalhes de Um Livro
------------------------------------------
```python
def detalhe_livro(request, livro_id):
    livro = get_object_or_404(Livro, pk=livro_id)
```
O QUE FAZ:
1. Recebe livro_id da URL (/livros/42/)
2. Busca livro com esse ID
3. Se n√£o existir ‚Üí mostra p√°gina 404
4. Se existir ‚Üí continua

```python
    avaliacoes = livro.avaliacoes.order_by('-criado')[:10]
    pode_avaliar = False
    avaliacao_usuario = None
    progresso = None
    
    if request.user.is_authenticated:
        progresso = ProgressoLeitura.objects.filter(
            usuario=request.user, livro=livro
        ).first()
        
        if progresso and progresso.status == "CONCLUIDO":
            pode_avaliar = True
            avaliacao_usuario = Avaliacao.objects.filter(
                usuario=request.user, livro=livro
            ).first()
```
O QUE FAZ:
1. Busca √∫ltimas 10 avalia√ß√µes do livro
2. Inicializa vari√°veis
3. Se usu√°rio logado:
   - Busca progresso dele neste livro
   - Se terminou de ler (CONCLUIDO):
     * pode_avaliar = True (pode deixar avalia√ß√£o)
     * Busca se j√° avaliou antes

```python
    parodi

a_motivacional = random.choice(PARODIAS_MOTIVACIONAIS)
```
O QUE FAZ:
1. random.choice() escolhe UMA par√≥dia aleat√≥ria da lista
2. Usado para mensagens engra√ßadas motivacionais
3. Cada vez que carrega a p√°gina, frase diferente


================================================================================
VIEWS DE USU√ÅRIO (Precisa estar logado - @login_required)
================================================================================

4) meus_livros() - Biblioteca do Usu√°rio
-----------------------------------------
```python
@login_required
def meus_livros(request):
    progressos = ProgressoLeitura.objects.filter(
        usuario=request.user
    ).select_related('livro__escritor', 'livro__editora')
```
O QUE FAZ:
1. @login_required ‚Üí se n√£o logado, redireciona pro login
2. Busca progressos DO USU√ÅRIO LOGADO apenas
3. select_related() ‚Üí OTIMIZA√á√ÉO:
   - Carrega livro + escritor + editora em 1 query s√≥
   - Sem isso: 1 query por livro (lento!)

```python
    status_filtro = request.GET.get('status')
    if status_filtro:
        progressos = progressos.filter(status=status_filtro)
```
O QUE FAZ:
1. Pega ?status=LENDO da URL
2. Filtra apenas livros com esse status
3. Usado para abas: "Lendo", "Conclu√≠dos", "Pausados"


5) adicionar_livro() - Adicionar √† Biblioteca
----------------------------------------------
```python
@login_required
def adicionar_livro(request, livro_id):
    livro = get_object_or_404(Livro, pk=livro_id)
    
    ja_existe = ProgressoLeitura.objects.filter(
        usuario=request.user, livro=livro
    ).exists()
    
    if ja_existe:
        messages.warning(request, 'Livro j√° est√° na sua biblioteca!')
    else:
        ProgressoLeitura.objects.create(
            usuario=request.user,
            livro=livro
        )
        messages.success(request, f'"{livro.titulo}" adicionado!')
    
    return redirect('meus_livros')
```
O QUE FAZ PASSO A PASSO:
1. Busca livro pelo ID
2. Verifica se usu√°rio J√Å TEM esse livro (.exists() ‚Üí True/False)
3. Se J√Å TEM:
   - Mostra mensagem de aviso
4. Se N√ÉO TEM:
   - Cria novo ProgressoLeitura
   - Status padr√£o = "LENDO"
   - P√°ginas = 0
   - Pontos = 0
   - Mostra mensagem de sucesso
5. Redireciona pra "Meus Livros"


6) atualizar_progresso() - Atualizar P√°ginas Lidas
---------------------------------------------------
```python
@login_required
def atualizar_progresso(request, progresso_id):
    if request.method != 'POST':
        return redirect('meus_livros')
    
    progresso = get_object_or_404(
        ProgressoLeitura, pk=progresso_id, usuario=request.user
    )
```
O QUE FAZ:
1. S√≥ aceita POST (n√£o funciona com GET)
2. Busca progresso pelo ID
3. E GARANTE que √© do usu√°rio logado (seguran√ßa!)
4. Se progresso for de outro usu√°rio ‚Üí 404

```python
    paginas = int(request.POST.get('paginas', 0))
    novo_status = request.POST.get('status', progresso.status)
    
    if paginas < 0:
        paginas = 0
    if paginas > progresso.livro.numero_paginas:
        paginas = progresso.livro.numero_paginas
```
O QUE FAZ:
1. Pega n√∫mero de p√°ginas do formul√°rio
2. Pega novo status (se mudou)
3. VALIDA√á√ïES:
   - Se negativo ‚Üí for√ßa 0
   - Se maior que total ‚Üí for√ßa total do livro
4. Evita valores inv√°lidos

```python
    acabou_de_concluir = progresso.atualizar_por_pagina(paginas)
    progresso.status = novo_status
    progresso.save()
    
    if acabou_de_concluir:
        return redirect('celebrar_conclusao', progresso_id=progresso.id)
```
O QUE FAZ:
1. Chama m√©todo do MODEL que:
   - Atualiza p√°ginas
   - Calcula pontos ganhos
   - Verifica se terminou
2. Atualiza status
3. Salva no banco
4. Se ACABOU DE TERMINAR ‚Üí redireciona pra tela de comemora√ß√£o
5. Se n√£o ‚Üí volta pra "Meus Livros"


7) celebrar_conclusao() - Tela de Parab√©ns
-------------------------------------------
```python
@login_required
def celebrar_conclusao(request, progresso_id):
    progresso = get_object_or_404(
        ProgressoLeitura, pk=progresso_id, usuario=request.user, status="CONCLUIDO"
    )
```
O QUE FAZ:
1. Busca progresso
2. GARANTE que:
   - √â do usu√°rio logado
   - Status √© CONCLUIDO
3. Se n√£o for ‚Üí 404 (n√£o pode celebrar livro n√£o terminado!)

```python
    def obter_ranking():
        return Usuario.objects.annotate(
            total_pontos=Sum('progressoleitura__pontos')
        ).filter(total_pontos__gt=0).order_by('-total_pontos')
    
    ranking = obter_ranking()
    posicao_usuario = None
    for idx, usuario in enumerate(ranking, start=1):
        if usuario.id == request.user.id:
            posicao_usuario = idx
            break
```
O QUE FAZ:
1. Define fun√ß√£o helper obter_ranking()
   - Calcula total de pontos de CADA usu√°rio
   - Filtra quem tem pontos
   - Ordena do maior pro menor
2. Busca posi√ß√£o do usu√°rio atual no ranking
3. enumerate(start=1) ‚Üí conta a partir de 1 (1¬∫, 2¬∫, 3¬∫...)

```python
    bonus_map = {
        1: Decimal(BONUS_PODIO_OURO),
        2: Decimal(BONUS_PODIO_PRATA),
        3: Decimal(BONUS_PODIO_BRONZE)
    }
    bonus_podio = bonus_map.get(posicao_usuario, Decimal('0.00'))
```
O QUE FAZ:
1. Cria dicion√°rio com b√¥nus por posi√ß√£o
2. Se usu√°rio est√° em 1¬∫ ‚Üí b√¥nus de ouro
3. Se 2¬∫ ‚Üí prata, se 3¬∫ ‚Üí bronze
4. Se n√£o est√° no p√≥dio ‚Üí 0.00
5. .get() retorna valor ou padr√£o se n√£o encontrar

```python
    if bonus_podio > 0:
        progresso.pontos += bonus_podio
        progresso.save()
        messages.success(request, f'B√¥nus de p√≥dio: +{bonus_podio} Janjetas!')
```
O QUE FAZ:
1. Se ganhou b√¥nus de p√≥dio:
   - Adiciona aos pontos
   - Salva
   - Mostra mensagem


8) avaliar_livro() - Criar/Editar Avalia√ß√£o
--------------------------------------------
```python
@login_required
def avaliar_livro(request, livro_id):
    livro = get_object_or_404(Livro, pk=livro_id)
    progresso = get_object_or_404(
        ProgressoLeitura, usuario=request.user, livro=livro, status="CONCLUIDO"
    )
```
O QUE FAZ:
1. Busca livro
2. GARANTE que usu√°rio TERMINOU de ler
3. Se n√£o terminou ‚Üí 404 (n√£o pode avaliar!)

```python
    avaliacao_existente = Avaliacao.objects.filter(
        usuario=request.user, livro=livro
    ).first()
    
    if request.method == 'POST':
        nota = int(request.POST.get('nota'))
        comentario = request.POST.get('comentario', '').strip()
        
        if avaliacao_existente:
            avaliacao_existente.nota = nota
            avaliacao_existente.comentario = comentario
            avaliacao_existente.save()
            messages.success(request, 'Avalia√ß√£o atualizada!')
        else:
            Avaliacao.objects.create(
                usuario=request.user,
                livro=livro,
                nota=nota,
                comentario=comentario
            )
            messages.success(request, 'Avalia√ß√£o publicada!')
```
O QUE FAZ:
1. Verifica se j√° avaliou antes
2. Se enviou formul√°rio (POST):
   - Pega nota e coment√°rio
   - Se J√Å AVALIOU: atualiza avalia√ß√£o existente
   - Se N√ÉO: cria nova avalia√ß√£o
3. Signal autom√°tico atualiza nota_media do livro


9) perfil() - Perfil do Usu√°rio
--------------------------------
```python
@login_required
def perfil(request):
    total_pontos = ProgressoLeitura.objects.filter(
        usuario=request.user
    ).aggregate(Sum('pontos'))['pontos__sum'] or Decimal('0.00')
    
    livros_concluidos = ProgressoLeitura.objects.filter(
        usuario=request.user, status="CONCLUIDO"
    ).count()
    
    livros_lendo = ProgressoLeitura.objects.filter(
        usuario=request.user, status="LENDO"
    ).count()
```
O QUE FAZ:
1. Calcula total de pontos (Janjetas)
   - aggregate() retorna dicion

√°rio
   - ['pontos__sum'] pega valor
   - or Decimal('0.00') ‚Üí se None, usa 0
2. Conta livros conclu√≠dos
3. Conta livros lendo atualmente

```python
    ranking = Usuario.objects.annotate(
        total_pontos=Sum('progressoleitura__pontos')
    ).filter(total_pontos__gt=0).order_by('-total_pontos')
    
    posicao = None
    for idx, usuario in enumerate(ranking, start=1):
        if usuario.id == request.user.id:
            posicao = idx
            break
```
O QUE FAZ:
1. Calcula ranking geral
2. Encontra posi√ß√£o do usu√°rio
3. Mostra "Voc√™ est√° em 5¬∫ lugar no ranking!"


10) ranking_pontos() - Ranking Geral
-------------------------------------
```python
def ranking_pontos(request):
    usuarios = Usuario.objects.annotate(
        total_pontos=Sum('progressoleitura__pontos')
    ).filter(total_pontos__gt=0).order_by('-total_pontos')[:50]
```
O QUE FAZ:
1. Para CADA usu√°rio, soma seus pontos
2. Filtra apenas quem tem pontos (> 0)
3. Ordena do maior pro menor
4. [:50] pega top 50
5. No template: {{ forloop.counter }} mostra posi√ß√£o


================================================================================
VIEWS DE ADMINISTRA√á√ÉO (Precisa ser staff - @staff_member_required)
================================================================================

11) gerenciar_dashboard() - Dashboard Admin
--------------------------------------------
```python
@staff_member_required
def gerenciar_dashboard(request):
    total_livros = Livro.objects.count()
    total_escritores = Escritor.objects.count()
    total_editoras = Editora.objects.count()
    total_usuarios = Usuario.objects.count()
```
O QUE FAZ:
1. Conta registros no banco
2. Mostra estat√≠sticas gerais
3. Apenas staff pode acessar


12-26) CRUD de Livros, Escritores, Editoras
--------------------------------------------
Todas seguem o mesmo padr√£o:

CRIAR:
```python
@staff_member_required
def criar_livro(request):
    if request.method == 'POST':
        form = LivroForm(request.POST, request.FILES)
        if form.is_valid():
            form.save()
            messages.success(request, 'Livro criado!')
            return redirect('gerenciar_livros_lista')
    else:
        form = LivroForm()
    return render(request, 'leia_bem/gerenciar/livro_form.html', {'form': form})
```
O QUE FAZ:
1. Se GET: mostra formul√°rio vazio
2. Se POST:
   - Valida dados
   - Se v√°lido: salva e redireciona
   - Se inv√°lido: mostra erros

EDITAR:
```python
@staff_member_required
def editar_livro(request, livro_id):
    livro = get_object_or_404(Livro, pk=livro_id)
    if request.method == 'POST':
        form = LivroForm(request.POST, request.FILES, instance=livro)
        if form.is_valid():
            form.save()
            messages.success(request, 'Livro atualizado!')
            return redirect('gerenciar_livros_lista')
    else:
        form = LivroForm(instance=livro)
    return render(request, 'leia_bem/gerenciar/livro_form.html', {
        'form': form, 'livro': livro
    })
```
O QUE FAZ:
1. Busca objeto existente
2. instance=livro ‚Üí preenche formul√°rio com dados atuais
3. Se POST: atualiza objeto
4. Se GET: mostra formul√°rio preenchido

DELETAR:
```python
@staff_member_required
def deletar_livro(request, livro_id):
    livro = get_object_or_404(Livro, pk=livro_id)
    if request.method == 'POST':
        livro.delete()
        messages.success(request, 'Livro deletado!')
        return redirect('gerenciar_livros_lista')
    return render(request, 'leia_bem/gerenciar/livro_confirmar_delete.html', {
        'livro': livro
    })
```
O QUE FAZ:
1. Se GET: mostra p√°gina de confirma√ß√£o
2. Se POST: deleta do banco e redireciona
3. Padr√£o POST-Redirect-GET (seguran√ßa)


================================================================================
RESUMO DOS CONCEITOS APRENDIDOS
================================================================================

‚úÖ get_object_or_404() ‚Üí Busca ou 404
‚úÖ @login_required ‚Üí Exige login
‚úÖ @staff_member_required ‚Üí Exige admin
‚úÖ request.method == 'POST' ‚Üí Processa formul√°rio
‚úÖ messages.success/error/warning ‚Üí Feedback ao usu√°rio
‚úÖ redirect() ‚Üí Vai pra outra p√°gina
‚úÖ render() ‚Üí Mostra template
‚úÖ .filter() ‚Üí Filtra queryset
‚úÖ .aggregate() ‚Üí C√°lculo √∫nico
‚úÖ .annotate() ‚Üí Adiciona campo calculado
‚úÖ select_related() ‚Üí Otimiza√ß√£o (JOIN)
‚úÖ Q objects ‚Üí OR nas queries
‚úÖ form.is_valid() ‚Üí Valida formul√°rio
‚úÖ form.save() ‚Üí Salva no banco
‚úÖ instance=objeto ‚Üí Preenche formul√°rio

================================================================================
FIM DO COMPLEMENTO
================================================================================

Agora voc√™ entende EXATAMENTE o que cada view do projeto faz!
Leia este arquivo junto com o MINICURSO_DJANGO_BOOTSTRAP.txt para
dominar completamente Django! üöÄ
